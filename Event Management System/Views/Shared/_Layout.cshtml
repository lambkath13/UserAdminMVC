@using System.Security.Claims
@using Event_Management_System.Data
@using Event_Management_System.Enums
@using Microsoft.AspNetCore.Mvc.TagHelpers
@using Microsoft.EntityFrameworkCore
@inject AppDbContext _context
@inject IHttpContextAccessor HttpContextAccessor
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, shrink-to-fit=no">
    <title> Event management system </title>
    <link rel="icon" type="image/x-icon" href="~/image/main/2025-04-19 01.35.51.jpg" />
    <link href="~/assets/css/loader.css" rel="stylesheet" type="text/css" />
    <script src="~/assets/js/loader.js"></script>

    <!-- BEGIN GLOBAL MANDATORY STYLES -->
    <link href="https://fonts.googleapis.com/css?family=Nunito:400,600,700" rel="stylesheet">
    <link href="~/bootstrap/css/bootstrap.min.css" rel="stylesheet" type="text/css" />
    <link href="~/assets/css/plugins.css" rel="stylesheet" type="text/css" />
    <!-- END GLOBAL MANDATORY STYLES -->

    <!-- BEGIN PAGE LEVEL PLUGINS/CUSTOM STYLES -->
    <link href="~/plugins/flatpickr/flatpickr.css" rel="stylesheet" type="text/css">
    <link href="~/plugins/flatpickr/custom-flatpickr.css" rel="stylesheet" type="text/css">
    <link href="~/plugins/noUiSlider/nouislider.min.css" rel="stylesheet" type="text/css">
    <link href="~/plugins/noUiSlider/custom-nouiSlider.css" rel="stylesheet" type="text/css">
    <link href="~/plugins/bootstrap-range-Slider/bootstrap-slider.css" rel="stylesheet" type="text/css">
    <link href="~/plugins/apex/apexcharts.css" rel="stylesheet" type="text/css">
    <!-- END PAGE LEVEL PLUGINS/CUSTOM STYLES -->

    <!-- BEGIN CUSTOM STYLES -->
    <link href="~/assets/css/dashboard/dash_1.css" rel="stylesheet" type="text/css" />
    <link href="~/assets/css/users/user-profile.css" rel="stylesheet" type="text/css" />
    <link href="~/assets/css/scrollspyNav.css" rel="stylesheet" type="text/css" />
    <!-- END CUSTOM STYLES -->

    <!-- END PAGE LEVEL PLUGINS/CUSTOM STYLES -->

</head>

<body>
@{
    var isNotEmpty = HttpContextAccessor.HttpContext?.User?.Claims?
        .Where(x => x.Type == ClaimTypes.NameIdentifier)
        .Select(x => x.Value)
        .Any();

    User? user = null;
    List<Notification>? notifications = null;

    if (isNotEmpty == true)
    {
        var userId = HttpContextAccessor.HttpContext?.User.Identity is not ClaimsIdentity ? Guid.Empty : Guid.Parse(HttpContextAccessor.HttpContext.User.Claims
                .Where(x => x.Type == ClaimTypes.NameIdentifier)
                .Select(x => x.Value)
                .FirstOrDefault() ?? string.Empty);

        user = await _context.Users.FindAsync(userId);


        notifications = await _context.Notifications.OrderByDescending(x=>x.CreatedAt).Take(3).ToListAsync();
    }

}
<!-- BEGIN LOADER -->
<div id="load_screen">
    <div class="loader">
        <div class="loader-content">
            <div class="spinner-grow align-self-center"></div>
        </div>
    </div>
</div>
<!--  END LOADER -->

<!--  BEGIN NAVBAR  -->
<div class="header-container fixed-top">
    <header class="header navbar navbar-expand-sm">

        <ul class="navbar-item theme-brand flex-row  text-center">
            <li class="nav-item theme-logo">
                <a href="#">
                    <img src="~/image/main/2025-04-19 01.35.51.jpg" class="navbar-logo" alt="logo">
                </a>
            </li>
            <li class="nav-item theme-text">
                <a href="#" class="nav-link"> REST </a>
            </li>
        </ul>

        <ul class="navbar-item flex-row ml-md-0 ml-auto">
            <li class="nav-item align-self-center search-animated">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                     stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                     class="feather feather-search toggle-search">
                    <circle cx="11" cy="11" r="8"></circle>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                </svg>
                <form id="search-form" class="form-inline search-full form-inline search" role="search" method="get" action="@Context.Request.Path">
                    <div class="search-bar">
                        <input type="text" name="query" id="search-input"
                               class="form-control search-form-control ml-lg-auto"
                               placeholder="Search..." value="@Context.Request.Query["query"]">
                    </div>
                </form>
            </li>
        </ul>

        <ul class="navbar-item flex-row ml-md-auto">
            <li class="nav-item dropdown notification-dropdown">
                <a href="javascript:void(0);" class="nav-link dropdown-toggle" id="notificationDropdown"
                   data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                         stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                         class="feather feather-bell">
                        <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                        <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                    </svg>
                    @if (notifications?.Count > 0)
                    {
                        <span class="badge badge-pill badge-success animate__animated animate__bounceIn">@notifications.Count</span>
                    }
                </a>
                <div class="dropdown-menu position-absolute p-3" style="max-width: 800px; width: auto; border-radius: 15px;" aria-labelledby="notificationDropdown">
                    <div class="notification-scroll" style="max-height: 600px; overflow-y: auto;">
                        @if (notifications?.Any() == true)
                        {
                            int notificationIndex = 1;  <!-- Начинаем нумерацию с 1 -->
                            @foreach (var notification in notifications)
                            {
                                <div class="dropdown-item d-flex align-items-center py-3">
                                    <div class="d-flex align-items-center">
                                        <!-- Номер уведомления -->
                                        <span class="notification-number mr-3 text-muted">
                                #@notificationIndex
                            </span>
                                    </div>
                                    <div class="media-body">
                                        <div class="notification-para">
                                            <a href="@notification.Link" class="user-name font-weight-bold text-dark">@notification.Description</a>
                                            <p class="text-muted small mt-1"></p>
                                        </div>
                                    </div>
                                </div>
                                notificationIndex++; <!-- Увеличиваем номер для следующего уведомления -->
                            }
                        }
                        else
                        {
                            <div class="dropdown-item">No notifications</div>
                        }
                    </div>
                </div>
            </li>
            
            <li class="nav-item dropdown user-profile-dropdown">
                <a href="javascript:void(0);" class="nav-link dropdown-toggle user" id="userProfileDropdown"
                   data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                    @if (user is { AvatarUrl: not null })
                    {
                        <img  height="90" width="90" src="/image/@user.AvatarUrl" alt="avatar">
                    }
                    else
                    {
                        <img src="~/assets/img/90x90.jpg" alt="avatar">
                    }
                </a>
                @if (user is null)
                {
                    <div class="dropdown-menu position-absolute" aria-labelledby="userProfileDropdown">
                        <div class="">
                            <div class="dropdown-item">
                                <a href="/auth/login">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24"
                                         height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                         stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                                         class="feather feather-user">
                                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                        <circle cx="12" cy="7" r="4"></circle>
                                    </svg> Login</a>
                            </div>
                            <div class="dropdown-item">
                                <a href="/auth/register">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                         viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                         stroke-linecap="round" stroke-linejoin="round" class="feather feather-log-out">
                                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                                        <polyline points="16 17 21 12 16 7"></polyline>
                                        <line x1="21" y1="12" x2="9" y2="12"></line>
                                    </svg> Registration</a>
                            </div>
                        </div>
                    </div>
                }
                else
                {
                    <div class="dropdown-menu position-absolute" aria-labelledby="userProfileDropdown">
                        <div class="">
                            <div class="dropdown-item">
                                <a href="/user/me">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24"
                                         height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                         stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                                         class="feather feather-user">
                                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                        <circle cx="12" cy="7" r="4"></circle>
                                    </svg> My Profile</a>
                            </div>
                            <div class="dropdown-item">
                                <a href="/auth/logout">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                         viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                         stroke-linecap="round" stroke-linejoin="round" class="feather feather-log-out">
                                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                                        <polyline points="16 17 21 12 16 7"></polyline>
                                        <line x1="21" y1="12" x2="9" y2="12"></line>
                                    </svg> Sign Out</a>
                            </div>
                        </div>
                    </div>
                }
               
            </li>
        </ul>
    </header>
</div>
<!--  END NAVBAR  -->

<!--  BEGIN NAVBAR  -->
<div class="sub-header-container">
    <header class="header navbar navbar-expand-sm">
        <a href="javascript:void(0);" class="sidebarCollapse" data-placement="bottom">
            <svg
                xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                class="feather feather-menu">
                <line x1="3" y1="12" x2="21" y2="12"></line>
                <line x1="3" y1="6" x2="21" y2="6"></line>
                <line x1="3" y1="18" x2="21" y2="18"></line>
            </svg></a>

        <ul class="navbar-nav flex-row">
            <li>
                <div class="page-header">

                    <nav class="breadcrumb-one" aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="javascript:void(0);">Event management system</a></li>
                        </ol>
                    </nav>

                </div>
            </li>
        </ul>
    </header>
</div>
<!--  END NAVBAR  -->

<!--  BEGIN MAIN CONTAINER  -->
<div class="main-container" id="container">

    <div class="overlay"></div>
    <div class="search-overlay"></div>

    <!--  BEGIN SIDEBAR  -->
    <div class="sidebar-wrapper sidebar-theme">

        <nav id="sidebar">
            <div class="shadow-bottom"></div>
            <ul class="list-unstyled menu-categories" id="accordionExample">
                <li class="menu">
                    <a href="#dashboard" data-toggle="collapse" aria-expanded="false"
                       class="dropdown-toggle">
                        <div class="">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                 fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                 stroke-linejoin="round" class="feather feather-home">
                                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                                <polyline points="9 22 9 12 15 12 15 22"></polyline>
                            </svg>
                            <span>Events</span>
                        </div>
                        <div>
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                 fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                 stroke-linejoin="round" class="feather feather-chevron-right">
                                <polyline points="9 18 15 12 9 6"></polyline>
                            </svg>
                        </div>
                    </a>
                    <ul class="collapse submenu list-unstyled" id="dashboard" data-parent="#accordionExample">
                        <li>
                            <a href="/home/index"> List </a>
                        </li>
                        @if (user is not null)
                        {
                            <li>
                                <a href="/event/getAllMyEvents">My List </a>
                            </li>
                        }
                        @if (user is { Role: UserRole.Admin }) 
                        {
                            <li>
                                <a href="/event/create"> Create </a>
                            </li>
                        }
                    </ul>
                </li>

                @if (user is { Role: UserRole.Admin })
                {
                    <li class="menu">
                        <a href="#elements" data-toggle="collapse" aria-expanded="false" class="dropdown-toggle">
                            <div class="">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-zap"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>
                                <span>Posts</span>
                            </div>
                            <div>
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"><polyline points="9 18 15 12 9 6"></polyline></svg>
                            </div>
                        </a>
                        <ul class="collapse submenu list-unstyled" id="elements" data-parent="#accordionExample">
                            <li>
                                <a href="/post/getAll"> List </a>
                            </li>
                        </ul>
                    </li>
                }
                
                @if (user is { Role: UserRole.Admin })
                {
                   <li class="menu">
                    <a href="#app" data-toggle="collapse" aria-expanded="false" class="dropdown-toggle">
                        <div class="">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                 fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                 stroke-linejoin="round" class="feather feather-cpu">
                                <rect x="4" y="4" width="16" height="16" rx="2" ry="2"></rect>
                                <rect x="9" y="9" width="6" height="6"></rect>
                                <line x1="9" y1="1" x2="9" y2="4"></line>
                                <line x1="15" y1="1" x2="15" y2="4"></line>
                                <line x1="9" y1="20" x2="9" y2="23"></line>
                                <line x1="15" y1="20" x2="15" y2="23"></line>
                                <line x1="20" y1="9" x2="23" y2="9"></line>
                                <line x1="20" y1="14" x2="23" y2="14"></line>
                                <line x1="1" y1="9" x2="4" y2="9"></line>
                                <line x1="1" y1="14" x2="4" y2="14"></line>
                            </svg>
                            <span>Users</span>
                        </div>
                        <div>
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                 fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                 stroke-linejoin="round" class="feather feather-chevron-right">
                                <polyline points="9 18 15 12 9 6"></polyline>
                            </svg>
                        </div>
                    </a>
                    <ul class="collapse submenu list-unstyled" id="app" data-parent="#accordionExample">
                        <li>
                            <a href="/user/getAll"> List </a>
                        </li>
                        <li>
                            <a href="/user/create"> Add </a>
                        </li>
                    </ul>
                </li>
                }
            </ul>
            <!-- <div class="shadow-bottom"></div> -->
        </nav>
    </div>
    <!--  END SIDEBAR  -->

    <!--  BEGIN CONTENT AREA  -->
    <div id="content" class="main-content">
        @RenderBody()
    </div>
    <!--  END CONTENT AREA  -->

</div>
<!-- END MAIN CONTAINER -->

<!-- BEGIN GLOBAL MANDATORY SCRIPTS -->
<!-- BEGIN GLOBAL MANDATORY SCRIPTS -->
<script src="~/assets/js/libs/jquery-3.1.1.min.js"></script>
<script src="~/bootstrap/js/popper.min.js"></script>
<script src="~/bootstrap/js/bootstrap.min.js"></script>
<script src="~/plugins/perfect-scrollbar/perfect-scrollbar.min.js"></script>
<script src="~/assets/js/app.js"></script>
<script src="~/assets/js/custom.js"></script>

<script>
    $(document).ready(function () {
        App.init();
    });
</script>

<script src="~/plugins/flatpickr/flatpickr.js"></script>
<script src="~/plugins/flatpickr/custom-flatpickr.js"></script>
<script>
    flatpickr("#rangeCalendarFlatpickr", {
        mode: "range",
        dateFormat: "Y-m-d",
        onChange: function(selectedDates, dateStr, instance) {
            // dateStr будет в формате "2025-04-18 to 2025-04-21"
            document.getElementById("EventDateHidden").value = dateStr;
        }
    });
</script>
<!-- END GLOBAL MANDATORY SCRIPTS -->

<!-- BEGIN PAGE LEVEL PLUGINS/CUSTOM SCRIPTS -->
<script src="~/plugins/apex/apexcharts.min.js"></script>
<script src="~/assets/js/dashboard/dash_1.js"></script>
<script src="~/plugins/jquery-ui/jquery-ui.min.js"></script>
<script src="~/plugins/highlight/highlight.pack.js"></script>
<script src="~/assets/js/scrollspyNav.js"></script>
<script src="~/plugins/noUiSlider/nouislider.min.js"></script>
<script src="~/plugins/noUiSlider/custom-nouiSlider.js"></script>
<script src="~/plugins/bootstrap-range-Slider/bootstrap-rangeSlider.js"></script>
<!-- END PAGE LEVEL PLUGINS/CUSTOM SCRIPTS -->
<script>
    $(document).on("click", "#subscribeButton", function () {
        var eventId = $(this).data("event-id");
        var userId = $(this).data("user-id");

        $.ajax({
            url: '/event/subscribe/' + eventId + '/user/' + userId,
            type: 'GET',
            success: function (response) {
                // Redirect to another page or update UI after successful subscription
                window.location.href = "/event/getAll";
            },
            error: function (xhr, status, error) {
                // Выводим подробную информацию о ошибке в консоль
                console.error('Error Status: ' + status);
                console.error('Error Thrown: ' + error);
                console.error('Response Text: ' + xhr.responseText);

                // Показываем сообщение пользователю
                alert('There was an error subscribing to the event. Please try again later.');
            }
        });
    });
</script>
<script>
    const searchInput = document.getElementById('search-input');
    const searchForm = document.getElementById('search-form');
    let timeout = null;

    searchInput.addEventListener('input', function () {
        clearTimeout(timeout);
        timeout = setTimeout(() => {
            searchForm.submit();
        }, 500); // Задержка 500мс, чтобы не отправлять каждый символ
    });
</script>
</body>

</html>